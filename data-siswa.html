<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CADENZA — Data Siswa</title>

    <!-- Vendor CSS -->
    <link
      rel="stylesheet"
      href="assets/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="shortcut icon" href="assets/images/favicon.png" />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      #studentsTable thead {
        background-color: var(--bs-secondary);
        color: #fff;
      }
      .table td,
      .table th {
        vertical-align: middle;
      }
      .form-control,
      .form-select,
      .form-control:focus,
      .form-select:focus {
        color: #fff;
        background: #2b2f32;
        border-color: rgba(255, 255, 255, 0.25);
      }
      .form-control::placeholder {
        color: rgba(255, 255, 255, 0.65);
      }
      .form-control:focus,
      .form-select:focus {
        border-color: var(--bs-secondary);
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-secondary-rgb), 0.25);
      }
      .small-muted {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.85rem;
      }
      code {
        background: rgba(255, 255, 255, 0.08);
        padding: 0.1rem 0.25rem;
        border-radius: 0.25rem;
      }
      /* Pagination */
      .pagination-wrapper {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .pagination {
        margin: 0;
      }
      .page-link {
        cursor: pointer;
      }
      /* Search row */
      .search-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }
      @media (max-width: 576px) {
        .search-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <div class="container-scroller">
      <!-- ===== Sidebar (tetap) ===== -->
      <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <div
          class="sidebar-brand-wrapper d-none d-lg-flex align-items-center justify-content-center fixed-top"
        >
          <a
            class="sidebar-brand brand-logo text-white fw-bold"
            href="index.html"
            >CADENZA</a
          >
          <a class="sidebar-brand brand-logo-mini" href="index.html"
            ><img src="assets/images/logo-mini.svg" alt="logo"
          /></a>
        </div>
        <ul class="nav">
          <li class="nav-item nav-category">
            <span class="nav-link">Menu</span>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link" href="index.html">
              <span class="menu-icon"><i class="mdi mdi-speedometer"></i></span>
              <span class="menu-title">Beranda</span>
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link active" href="data-siswa.html">
              <span class="menu-icon"
                ><i class="mdi mdi-account-group"></i
              ></span>
              <span class="menu-title">Data Siswa</span>
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link" href="data-nilai.html">
              <span class="menu-icon"
                ><i class="mdi mdi-clipboard-text"></i
              ></span>
              <span class="menu-title">Data Nilai</span>
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link" href="data-qr.html">
              <span class="menu-icon"><i class="mdi mdi-qrcode"></i></span>
              <span class="menu-title">Data QR</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Page content -->
      <div class="container-fluid page-body-wrapper">
        <!-- ===== Navbar (tetap) ===== -->
        <nav class="navbar p-0 fixed-top d-flex flex-row">
          <div
            class="navbar-brand-wrapper d-flex d-lg-none align-items-center justify-content-center"
          >
            <a class="navbar-brand brand-logo-mini" href="index.html"
              ><img src="assets/images/logo-mini.svg" alt="logo"
            /></a>
          </div>
          <div class="navbar-menu-wrapper flex-grow d-flex align-items-stretch">
            <button
              class="navbar-toggler navbar-toggler align-self-center"
              type="button"
              data-toggle="minimize"
            >
              <span class="mdi mdi-menu"></span>
            </button>
            <ul class="navbar-nav w-100"></ul>
            <ul class="navbar-nav navbar-nav-right">
              <li class="nav-item dropdown">
                <a
                  class="nav-link"
                  id="profileDropdown"
                  href="#"
                  data-toggle="dropdown"
                >
                  <div class="navbar-profile d-flex align-items-center">
                    <img
                      id="profilePhoto"
                      class="img-xs rounded-circle me-2"
                      src="assets/images/faces/face15.jpg"
                      alt=""
                    />
                    <p
                      id="profileName"
                      class="mb-0 d-none d-sm-block navbar-profile-name"
                    >
                      Pengguna
                    </p>
                    <i class="mdi mdi-menu-down d-none d-sm-block ms-1"></i>
                  </div>
                </a>
                <div
                  class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list"
                  aria-labelledby="profileDropdown"
                >
                  <div class="dropdown-divider"></div>
                  <a id="logoutBtn" class="dropdown-item preview-item" href="#">
                    <div class="preview-thumbnail">
                      <div class="preview-icon bg-dark rounded-circle">
                        <i class="mdi mdi-logout text-danger"></i>
                      </div>
                    </div>
                    <div class="preview-item-content">
                      <p class="preview-subject mb-1">Log out</p>
                    </div>
                  </a>
                </div>
              </li>
            </ul>
            <button
              class="navbar-toggler navbar-toggler-right d-lg-none align-self-center"
              type="button"
              data-toggle="offcanvas"
            >
              <span class="mdi mdi-format-line-spacing"></span>
            </button>
          </div>
        </nav>

        <div class="main-panel">
          <div class="content-wrapper">
            <div
              class="d-flex align-items-center justify-content-between flex-wrap gap-2"
            >
              <h4 class="mb-0">Data Siswa</h4>
              <div class="d-flex gap-2">
                <button id="btnImportExcel" class="btn btn-sm btn-outline-info">
                  <i class="mdi mdi-file-import"></i> Import Excel
                </button>
                <button
                  id="btnExportExcel"
                  class="btn btn-sm btn-outline-success"
                >
                  <i class="mdi mdi-file-excel"></i> Export Excel
                </button>
                <button id="btnAddStudent" class="btn btn-sm btn-primary">
                  <i class="mdi mdi-plus"></i> Tambah Siswa
                </button>
              </div>
            </div>
            <div class="small-muted mt-2">
              Import menerima file .xlsx. Kolom “Timestamp” (jika ada) akan
              diabaikan otomatis.
            </div>

            <!-- Search Bar -->
            <div class="card mt-3">
              <div class="card-body">
                <div class="search-grid">
                  <div>
                    <label class="form-label mb-1">Cari ID</label>
                    <input
                      type="text"
                      id="searchId"
                      class="form-control"
                      placeholder="Ketik ID siswa..."
                    />
                  </div>
                  <div>
                    <label class="form-label mb-1">Cari Nama</label>
                    <input
                      type="text"
                      id="searchNama"
                      class="form-control"
                      placeholder="Ketik nama siswa..."
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- hidden file input -->
            <input
              id="fileInput"
              type="file"
              accept=".xlsx,.xls"
              class="d-none"
            />

            <div class="row mt-3">
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <div class="table-responsive">
                      <table
                        id="studentsTable"
                        class="table table-striped table-hover align-middle"
                      >
                        <thead class="table-secondary">
                          <tr>
                            <th>#</th>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Tempat Lahir</th>
                            <th>Tanggal Lahir</th>
                            <th>Jenis Kelamin</th>
                            <th>Alamat</th>
                            <th>No Hp</th>
                            <th>Nama Orang Tua</th>
                            <th>No Hp Orang Tua</th>
                            <th>Pilihan Instrumen</th>
                            <th>Pilihan Paket Pertemuan</th>
                            <th>Aksi</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>

                    <!-- PAGINATION -->
                    <div class="pagination-wrapper mt-3">
                      <div id="pageInfo" class="small-muted">
                        Menampilkan 0–0 dari 0
                      </div>
                      <nav aria-label="Page navigation">
                        <ul
                          id="pagination"
                          class="pagination pagination-sm mb-0"
                        >
                          <!-- Buttons will be injected by JS -->
                        </ul>
                      </nav>
                    </div>
                    <!-- /PAGINATION -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal Form -->
            <div
              class="modal fade"
              id="studentModal"
              tabindex="-1"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <form id="studentForm" novalidate>
                    <div class="modal-header">
                      <h5 class="modal-title">Tambah / Edit Siswa</h5>
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                      ></button>
                    </div>

                    <div class="modal-body">
                      <input type="hidden" id="studentId" />
                      <div class="row g-3">
                        <!-- ID Siswa (doc id) -->
                        <div class="col-12">
                          <label
                            for="studentIdView"
                            class="form-label d-flex align-items-center justify-content-between"
                          >
                            <span>ID Siswa</span>
                            <button
                              type="button"
                              id="toggleEditIdBtn"
                              class="btn btn-sm btn-outline-warning"
                            >
                              Ubah ID
                            </button>
                          </label>
                          <input
                            type="text"
                            id="studentIdView"
                            class="form-control"
                            placeholder="(ID otomatis)"
                            disabled
                            pattern="^[a-zA-Z0-9_\-]{4,128}$"
                            title="Huruf, angka, '-' atau '_', min 4 karakter"
                          />
                          <div class="form-text">
                            Format: huruf/angka/dash/underscore. Contoh:
                            <code>dilif_001</code>.
                          </div>
                        </div>

                        <!-- Nama / Tempat Lahir -->
                        <div class="col-md-6">
                          <label for="namaSiswa" class="form-label">Nama</label>
                          <input
                            type="text"
                            id="namaSiswa"
                            class="form-control"
                            required
                            pattern="^[A-Za-zÀ-ž\s'-]+$"
                            title="Hanya huruf, spasi, '-', dan apostrof"
                          />
                          <div class="invalid-feedback">
                            Nama hanya boleh huruf.
                          </div>
                        </div>
                        <div class="col-md-6">
                          <label for="tempatLahir" class="form-label"
                            >Tempat Lahir</label
                          >
                          <input
                            type="text"
                            id="tempatLahir"
                            class="form-control"
                            required
                            pattern="^[A-Za-zÀ-ž\s]+$"
                            title="Hanya huruf dan spasi"
                          />
                          <div class="invalid-feedback">
                            Tempat lahir hanya huruf.
                          </div>
                        </div>

                        <!-- Tanggal / Jenis Kelamin -->
                        <div class="col-md-4">
                          <label for="tanggalLahir" class="form-label"
                            >Tanggal Lahir</label
                          >
                          <input
                            type="date"
                            id="tanggalLahir"
                            class="form-control"
                            required
                          />
                          <div class="invalid-feedback">
                            Tanggal lahir wajib.
                          </div>
                        </div>
                        <div class="col-md-4">
                          <label for="jenisKelamin" class="form-label"
                            >Jenis Kelamin</label
                          >
                          <select
                            id="jenisKelamin"
                            class="form-control form-select"
                            required
                          >
                            <option value="">Pilih...</option>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                            <option value="Lainnya">Lainnya</option>
                          </select>
                          <div class="invalid-feedback">
                            Pilih jenis kelamin.
                          </div>
                        </div>

                        <!-- Alamat -->
                        <div class="col-12">
                          <label for="alamat" class="form-label">Alamat</label>
                          <textarea
                            id="alamat"
                            class="form-control"
                            rows="2"
                            required
                          ></textarea>
                          <div class="invalid-feedback">
                            Alamat wajib diisi.
                          </div>
                        </div>

                        <!-- Telepon / Orang Tua -->
                        <div class="col-md-6">
                          <label for="noTelepon" class="form-label"
                            >No Hp</label
                          >
                          <input
                            type="text"
                            id="noTelepon"
                            class="form-control"
                            required
                            pattern="^[0-9]{8,20}$"
                            title="Hanya angka 8–20 digit"
                          />
                          <div class="invalid-feedback">
                            Masukkan angka 8–20 digit.
                          </div>
                        </div>
                        <div class="col-md-6">
                          <label for="namaOrtu" class="form-label"
                            >Nama Orang Tua</label
                          >
                          <input
                            type="text"
                            id="namaOrtu"
                            class="form-control"
                            required
                            pattern="^[A-Za-zÀ-ž\s'-]+$"
                            title="Hanya huruf, spasi, '-', dan apostrof"
                          />
                          <div class="invalid-feedback">
                            Nama orang tua hanya huruf.
                          </div>
                        </div>
                        <div class="col-md-6">
                          <label for="noTeleponOrtu" class="form-label"
                            >No Hp Orang Tua</label
                          >
                          <input
                            type="text"
                            id="noTeleponOrtu"
                            class="form-control"
                            required
                            pattern="^[0-9]{8,20}$"
                            title="Hanya angka 8–20 digit"
                          />
                          <div class="invalid-feedback">
                            Masukkan angka 8–20 digit.
                          </div>
                        </div>

                        <!-- MULTI SELECT INSTRUMEN -->
                        <div class="col-md-6">
                          <label for="pilihanIstrumen" class="form-label"
                            >Pilihan Instrumen</label
                          >
                          <select
                            id="pilihanIstrumen"
                            class="form-control form-select"
                            multiple
                            required
                          >
                            <option value="Gitar Klasik">Gitar Klasik</option>
                            <option value="Gitar Pop">Gitar Pop</option>
                            <option value="Piano Klasik">Piano Klasik</option>
                            <option value="Piano Pop">Piano Pop</option>
                            <option value="Biola Klasik">Biola Klasik</option>
                            <option value="Biola Pop">Biola Pop</option>
                            <option value="Vocal">Vocal</option>
                            <option value="Drum">Drum</option>
                            <option value="Keyboard">Keyboard</option>
                          </select>
                          <div class="small text-muted">
                            Tahan Ctrl/⌘ untuk pilih lebih dari satu.
                          </div>
                          <div class="invalid-feedback">
                            Pilih minimal satu instrumen.
                          </div>
                        </div>

                        <!-- Paket -->
                        <div class="col-md-6">
                          <label for="pilihanPaket" class="form-label"
                            >Pilihan Paket Pertemuan</label
                          >
                          <select
                            id="pilihanPaket"
                            class="form-control form-select"
                            required
                          >
                            <option value="">Pilih...</option>
                            <option value="A">Paket A (4x pertemuan)</option>
                            <option value="B">Paket B (8x pertemuan)</option>
                          </select>
                          <div class="invalid-feedback">Pilih paket.</div>
                        </div>
                      </div>
                    </div>

                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Batal
                      </button>
                      <button
                        type="submit"
                        id="saveStudentBtn"
                        class="btn btn-primary"
                      >
                        Simpan
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <!-- /Modal -->
          </div>

          <footer class="footer">
            <div
              class="d-sm-flex justify-content-center justify-content-sm-between"
            >
              <span
                class="text-muted d-block text-center text-sm-left d-sm-inline-block"
                >Copyright © 2025</span
              >
            </div>
          </footer>
        </div>
      </div>
    </div>

    <!-- Vendor JS -->
    <script src="assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- App logic -->
    <script type="module">
      /* 1) Import dari firebase.js: db + helper */
      import {
        requireAuthRedirect,
        db,
        onStudentsSnapshot,
        getStudent,
        addStudent,
        updateStudent,
        deleteStudent,
        onAuthStateChangedHandler,
        signOut,
      } from "./firebase.js";

      /* 2) Util Firestore langsung dari CDN (versi sama dgn firebase.js) */
      import {
        collection,
        doc,
        getDoc,
        setDoc,
        deleteDoc,
        query,
        where,
        getDocs,
        writeBatch,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      await requireAuthRedirect();
      /* ====== KONFIG NAMA KOLEKSI ====== */
      const STUDENTS_COL = "siswa";
      const NILAI_COL = "nilai";

      /* ====== UI REFS ====== */
      const modalEl = document.getElementById("studentModal");
      const modal = new bootstrap.Modal(modalEl);
      const studentForm = document.getElementById("studentForm");
      const tableBody = document.querySelector("#studentsTable tbody");
      const btnExportExcel = document.getElementById("btnExportExcel");
      const btnImportExcel = document.getElementById("btnImportExcel");
      const fileInput = document.getElementById("fileInput");

      const pageInfo = document.getElementById("pageInfo");
      const paginationEl = document.getElementById("pagination");

      const searchId = document.getElementById("searchId");
      const searchNama = document.getElementById("searchNama");

      /* Auth (tetap) */
      const profileName = document.getElementById("profileName");
      const profilePhoto = document.getElementById("profilePhoto");
      const logoutBtn = document.getElementById("logoutBtn");
      onAuthStateChangedHandler((user) => {
        if (user) {
          profileName.textContent =
            user.displayName || user.email || "Pengguna";
          if (user.photoURL) profilePhoto.src = user.photoURL;
        } else {
          profileName.textContent = "Pengguna";
          profilePhoto.src = "assets/images/faces/face15.jpg";
        }
      });
      logoutBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        const ask = await Swal.fire({
          title: "Log out?",
          text: "Kamu akan keluar dari sesi ini.",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Keluar",
          cancelButtonText: "Batal",
        });
        if (ask.isConfirmed) {
          await signOut();
          Swal.fire("Berhasil", "Kamu sudah logout.", "success");
        }
      });

      /* Form fields */
      const studentIdInput = document.getElementById("studentId"); // hidden
      const studentIdView = document.getElementById("studentIdView");
      const toggleEditIdBtn = document.getElementById("toggleEditIdBtn");
      const namaSiswa = document.getElementById("namaSiswa");
      const tempatLahir = document.getElementById("tempatLahir");
      const tanggalLahir = document.getElementById("tanggalLahir");
      const jenisKelamin = document.getElementById("jenisKelamin");
      const alamat = document.getElementById("alamat");
      const noTelepon = document.getElementById("noTelepon");
      const namaOrtu = document.getElementById("namaOrtu");
      const noTeleponOrtu = document.getElementById("noTeleponOrtu");
      const pilihanIstrumen = document.getElementById("pilihanIstrumen");
      const pilihanPaket = document.getElementById("pilihanPaket");

      /* Validators */
      const onlyLetters = /[^A-Za-zÀ-ž\s'\-]/g,
        onlyNumbers = /[^0-9]/g;
      [namaSiswa, tempatLahir, namaOrtu].forEach((el) =>
        el.addEventListener(
          "input",
          () => (el.value = el.value.replace(onlyLetters, ""))
        )
      );
      [noTelepon, noTeleponOrtu].forEach((el) =>
        el.addEventListener(
          "input",
          () => (el.value = el.value.replace(onlyNumbers, ""))
        )
      );

      /* Multi-select helpers */
      function getMultiSelectValues(selectEl) {
        return Array.from(selectEl.selectedOptions).map((o) => o.value);
      }
      function setMultiSelectValues(selectEl, values = []) {
        const set = new Set(values);
        Array.from(selectEl.options).forEach(
          (opt) => (opt.selected = set.has(opt.value))
        );
      }
      function validateInstrumenRequired() {
        const val = getMultiSelectValues(pilihanIstrumen);
        if (val.length === 0) {
          pilihanIstrumen.setCustomValidity("Pilih minimal satu instrumen");
        } else {
          pilihanIstrumen.setCustomValidity("");
        }
      }
      pilihanIstrumen.addEventListener("change", validateInstrumenRequired);

      /* ===== Helpers umum ===== */
      const INSTRUMEN_OPSI = new Set([
        "Gitar Klasik",
        "Gitar Pop",
        "Piano Klasik",
        "Piano Pop",
        "Biola Klasik",
        "Biola Pop",
        "Vocal",
        "Drum",
        "Keyboard",
      ]);
      function normalizeInstrumen(raw) {
        const v = String(raw || "").trim();
        if (!v) return "";
        for (const o of INSTRUMEN_OPSI) {
          if (o.toLowerCase() === v.toLowerCase()) return o;
        }
        const low = v.toLowerCase(),
          has = (w) => low.includes(w);
        if (has("gitar") && has("klasik")) return "Gitar Klasik";
        if (has("gitar") && has("pop")) return "Gitar Pop";
        if (has("piano") && has("klasik")) return "Piano Klasik";
        if (has("piano") && has("pop")) return "Piano Pop";
        if (has("biola") && has("klasik")) return "Biola Klasik";
        if (has("biola") && has("pop")) return "Biola Pop";
        if (has("vocal") || has("vokal")) return "Vocal";
        if (has("drum")) return "Drum";
        if (has("keyboard") || has("keybord")) return "Keyboard";
        return "";
      }
      function titleCaseNama(str = "") {
        return String(str)
          .trim()
          .split(/\s+/)
          .map((word) =>
            word
              .split(/([-'])/)
              .map((part) => {
                if (part === "-" || part === "'") return part;
                return (
                  part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
                );
              })
              .join("")
          )
          .join(" ");
      }
      function pad2(n) {
        return String(n).padStart(2, "0");
      }
      function excelSerialToYMD(n) {
        if (
          window.XLSX &&
          XLSX.SSF &&
          typeof XLSX.SSF.parse_date_code === "function"
        ) {
          const o = XLSX.SSF.parse_date_code(n);
          if (o) return `${o.y}-${pad2(o.m)}-${pad2(o.d)}`;
        }
        const epoch = new Date(Date.UTC(1899, 11, 30));
        const ms = Math.round(n * 86400000);
        const d = new Date(epoch.getTime() + ms);
        return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth() + 1)}-${pad2(
          d.getUTCDate()
        )}`;
      }
      function parseDateStringToYMD(s) {
        if (!s) return "";
        const str = String(s).trim();
        let m = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if (m) return `${m[1]}-${pad2(m[2])}-${pad2(m[3])}`;
        m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
        if (m) return `${m[3]}-${pad2(m[2])}-${pad2(m[1])}`;
        const d = new Date(str);
        if (!isNaN(d.valueOf()))
          return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(
            d.getDate()
          )}`;
        return str;
      }
      function normalizePhone(s) {
        if (s === null || s === undefined) return "";
        return String(s).trim().replace(/[^\d]/g, "");
      }
      function sanitizeId(id) {
        return String(id || "").trim();
      }
      function isValidId(id) {
        return /^[a-zA-Z0-9_\-]{4,128}$/.test(id);
      }

      // Normalisasi teks untuk pencarian (hilangkan aksen, lowercase)
      function normText(s) {
        return String(s ?? "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .trim();
      }

      /* ===== STATE & PAGINATION+FILTER ===== */
      let latestStudents = [];
      let filteredStudents = null; // array atau null (jika tidak ada filter)
      const pageSize = 10;
      let currentPage = 1; // 1-based

      function getDataSource() {
        return filteredStudents && Array.isArray(filteredStudents)
          ? filteredStudents
          : latestStudents;
      }
      function getTotalPages() {
        return Math.max(1, Math.ceil(getDataSource().length / pageSize));
      }
      function clampPage(p) {
        const t = getTotalPages();
        return Math.min(Math.max(1, p), t);
      }

      // Build pagination UI
      function buildPagination() {
        const total = getDataSource().length;
        const totalPages = getTotalPages();
        currentPage = clampPage(currentPage);

        paginationEl.innerHTML = "";

        const li = (disabled, active, label, gotoPage, aria) => {
          const li = document.createElement("li");
          li.className = `page-item${disabled ? " disabled" : ""}${
            active ? " active" : ""
          }`;
          const a = document.createElement("a");
          a.className = "page-link";
          a.innerText = label;
          if (aria) a.setAttribute("aria-label", aria);
          if (!disabled)
            a.addEventListener("click", () => {
              setPage(gotoPage);
            });
          li.appendChild(a);
          return li;
        };

        // First / Prev
        paginationEl.appendChild(li(currentPage === 1, false, "«", 1, "First"));
        paginationEl.appendChild(
          li(currentPage === 1, false, "‹", currentPage - 1, "Previous")
        );

        // Page numbers (window 5)
        const windowSize = 5;
        const half = Math.floor(windowSize / 2);
        let start = Math.max(1, currentPage - half);
        let end = Math.min(getTotalPages(), start + windowSize - 1);
        if (end - start + 1 < windowSize)
          start = Math.max(1, end - windowSize + 1);

        for (let p = start; p <= end; p++) {
          paginationEl.appendChild(li(false, p === currentPage, String(p), p));
        }

        // Next / Last
        paginationEl.appendChild(
          li(currentPage === totalPages, false, "›", currentPage + 1, "Next")
        );
        paginationEl.appendChild(
          li(currentPage === totalPages, false, "»", totalPages, "Last")
        );

        // Page info
        const from = total === 0 ? 0 : (currentPage - 1) * pageSize + 1;
        const to = Math.min(total, currentPage * pageSize);
        pageInfo.textContent = `Menampilkan ${from}–${to} dari ${total}`;
      }

      function setPage(p) {
        currentPage = clampPage(p);
        renderStudentsPage();
      }

      // Render tabel sesuai halaman & filter
      function renderStudentsPage() {
        const data = getDataSource();
        const total = data.length;
        currentPage = clampPage(currentPage);

        tableBody.innerHTML = "";
        if (total === 0) {
          buildPagination();
          return;
        }

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(total, startIndex + pageSize);
        const slice = data.slice(startIndex, endIndex);

        slice.forEach((s, i) => {
          const instr = Array.isArray(s.pilihanIstrumen)
            ? s.pilihanIstrumen.join(", ")
            : s.pilihanIstrumen || "";
          const paketText =
            s.pilihanPaket === "A"
              ? "Paket A (4x pertemuan)"
              : s.pilihanPaket === "B"
              ? "Paket B (8x pertemuan)"
              : s.pilihanPaket || "";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${startIndex + i + 1}</td>
            <td>${s.id ?? ""}</td>
            <td>${s.namaSiswa ?? ""}</td>
            <td>${s.tempatLahir ?? ""}</td>
            <td>${s.tanggalLahir ?? ""}</td>
            <td>${s.jenisKelamin ?? ""}</td>
            <td>${s.alamat ?? ""}</td>
            <td>${s.noTelepon ?? ""}</td>
            <td>${s.namaOrtu ?? ""}</td>
            <td>${s.noTeleponOrtu ?? ""}</td>
            <td>${instr}</td>
            <td>${paketText}</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-primary btn-edit" data-id="${
                s.id
              }">Edit</button>
              <button class="btn btn-sm btn-danger btn-delete" data-id="${
                s.id
              }">Hapus</button>
            </td>`;
          tableBody.appendChild(tr);
        });

        // Re-bind edit/delete untuk halaman aktif
        document.querySelectorAll(".btn-edit").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.dataset.id;
            const data = await getStudent(id);
            if (!data)
              return Swal.fire("Error", "Data tidak ditemukan", "error");

            studentIdInput.value = id;
            studentIdView.value = id || "";
            isEditingId = false;
            studentIdView.disabled = true;
            toggleEditIdBtn.textContent = "Ubah ID";

            namaSiswa.value = data.namaSiswa || "";
            tempatLahir.value = data.tempatLahir || "";
            tanggalLahir.value = data.tanggalLahir || "";
            jenisKelamin.value = data.jenisKelamin || "";
            alamat.value = data.alamat || "";
            noTelepon.value = data.noTelepon || "";
            namaOrtu.value = data.namaOrtu || "";
            noTeleponOrtu.value = data.noTeleponOrtu || "";

            const arr = Array.isArray(data.pilihanIstrumen)
              ? data.pilihanIstrumen
              : data.pilihanIstrumen
              ? String(data.pilihanIstrumen).split(/,\s*/).filter(Boolean)
              : [];
            setMultiSelectValues(pilihanIstrumen, arr);
            pilihanPaket.value = data.pilihanPaket || "";

            modal.show();
          });
        });

        document.querySelectorAll(".btn-delete").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = e.currentTarget.dataset.id;
            const conf = await Swal.fire({
              title: "Hapus data?",
              text: "Tindakan ini tidak dapat dibatalkan.",
              icon: "warning",
              showCancelButton: true,
              confirmButtonText: "Ya, hapus",
              cancelButtonText: "Batal",
            });
            if (!conf.isConfirmed) return;
            await deleteStudent(id);

            // Sesuaikan halaman setelah hapus
            const afterCount = getDataSource().length - 1;
            const maxPage = Math.max(1, Math.ceil(afterCount / pageSize));
            if (currentPage > maxPage) currentPage = maxPage;
            Swal.fire("Dihapus", "Data siswa berhasil dihapus.", "success");
          });
        });

        buildPagination();
      }

      function renderStudents(students) {
        latestStudents = students;
        applyFilterAndRender(); // selalu re-apply filter saat data realtime berubah
      }

      /* ====== FILTER (Cari ID & Nama) ====== */
      function applyFilterAndRender() {
        const qId = normText(searchId.value);
        const qNama = normText(searchNama.value);

        if (!qId && !qNama) {
          filteredStudents = null; // tidak ada filter
        } else {
          filteredStudents = latestStudents.filter((s) => {
            const id = normText(s.id);
            const nama = normText(s.namaSiswa);
            const matchId = qId ? id.includes(qId) : true;
            const matchNama = qNama ? nama.includes(qNama) : true;
            return matchId && matchNama;
          });
        }
        currentPage = 1; // reset ke halaman pertama saat filter berubah
        renderStudentsPage();
      }

      // Debounce input (supaya tidak render tiap ketik 1 huruf)
      function debounce(fn, ms = 200) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }
      const onSearchChange = debounce(() => applyFilterAndRender(), 180);

      searchId.addEventListener("input", onSearchChange);
      searchNama.addEventListener("input", onSearchChange);

      /* ===== Migrasi ID (clone → update refs → delete) ===== */
      async function changeStudentId(oldId, newId, payload) {
        const newRef = doc(db, STUDENTS_COL, newId);
        const newSnap = await getDoc(newRef);
        if (newSnap.exists())
          throw new Error("ID baru sudah digunakan. Pilih ID lain.");

        // 1) buat dok baru
        await setDoc(newRef, { ...payload });

        // 2) update referensi di koleksi 'nilai'
        const q = query(
          collection(db, NILAI_COL),
          where("siswaId", "==", oldId)
        );
        const snap = await getDocs(q);
        if (!snap.empty) {
          let batch = writeBatch(db);
          let count = 0;
          snap.forEach((docSnap) => {
            batch.update(docSnap.ref, { siswaId: newId });
            count++;
            if (count % 450 === 0) {
              batch.commit();
              batch = writeBatch(db);
            }
          });
          await batch.commit();
        }

        // 3) hapus dok lama
        await deleteDoc(doc(db, STUDENTS_COL, oldId));
      }

      /* ===== Submit ===== */
      let isEditingId = false;
      toggleEditIdBtn.addEventListener("click", () => {
        isEditingId = !isEditingId;
        studentIdView.disabled = !isEditingId;
        toggleEditIdBtn.textContent = isEditingId ? "Batal Ubah ID" : "Ubah ID";
        if (!isEditingId) {
          studentIdView.value = studentIdInput.value || "";
        }
      });

      studentForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        validateInstrumenRequired();
        if (!studentForm.checkValidity()) {
          studentForm.classList.add("was-validated");
          return;
        }
        const payload = {
          namaSiswa: titleCaseNama(namaSiswa.value.trim()),
          tempatLahir: tempatLahir.value.trim(),
          tanggalLahir: tanggalLahir.value,
          jenisKelamin: jenisKelamin.value,
          alamat: alamat.value.trim(),
          noTelepon: noTelepon.value.trim(),
          namaOrtu: titleCaseNama(namaOrtu.value.trim()),
          noTeleponOrtu: noTeleponOrtu.value.trim(),
          pilihanIstrumen: getMultiSelectValues(pilihanIstrumen),
          pilihanPaket: pilihanPaket.value,
        };
        const oldId = studentIdInput.value || "";
        const newIdRaw = sanitizeId(studentIdView.value);
        const willChangeId =
          !!oldId && isEditingId && newIdRaw && newIdRaw !== oldId;

        Swal.showLoading();
        try {
          if (!oldId) {
            await addStudent(payload);
            Swal.fire("Berhasil", "Data siswa ditambahkan.", "success");
          } else if (willChangeId) {
            if (!isValidId(newIdRaw))
              throw new Error(
                "Format ID tidak valid. Gunakan huruf/angka/-/_ (4–128)."
              );
            const ask = await Swal.fire({
              title: "Ganti ID Siswa?",
              html: `Dari <b>${oldId}</b> ke <b>${newIdRaw}</b>.<br>Semua data nilai terkait akan ikut dipindah.`,
              icon: "warning",
              showCancelButton: true,
              confirmButtonText: "Ya, ganti ID",
              cancelButtonText: "Batal",
            });
            if (!ask.isConfirmed) return;
            await changeStudentId(oldId, newIdRaw, payload);
            Swal.fire(
              "Sukses",
              `ID siswa sudah diganti menjadi <b>${newIdRaw}</b>.`,
              "success"
            );
          } else {
            await updateStudent(oldId, payload);
            Swal.fire("Berhasil", "Data siswa diperbarui.", "success");
          }

          const inst = bootstrap.Modal.getInstance(modalEl);
          if (inst) inst.hide();
          studentForm.reset();
          studentIdInput.value = "";
          studentIdView.value = "";
          isEditingId = false;
          studentIdView.disabled = true;
          toggleEditIdBtn.textContent = "Ubah ID";
        } catch (err) {
          console.error(err);
          Swal.fire(
            "Gagal",
            err?.message || "Tidak dapat menyimpan data.",
            "error"
          );
        }
      });

      /* ===== Realtime ===== */
      onStudentsSnapshot((list) => {
        renderStudents(list);
      });

      /* ===== Export Excel (semua data, bukan yang terfilter) ===== */
      function toRow(s, i) {
        const instr = Array.isArray(s.pilihanIstrumen)
          ? s.pilihanIstrumen.join(", ")
          : s.pilihanIstrumen || "";
        const paketText =
          s.pilihanPaket === "A"
            ? "Paket A (4x pertemuan)"
            : s.pilihanPaket === "B"
            ? "Paket B (8x pertemuan)"
            : s.pilihanPaket || "";
        return {
          No: i + 1,
          ID: s.id || "",
          Nama: s.namaSiswa || "",
          "Tempat Lahir": s.tempatLahir || "",
          "Tanggal Lahir": s.tanggalLahir || "",
          "Jenis Kelamin": s.jenisKelamin || "",
          Alamat: s.alamat || "",
          "No Hp": s.noTelepon || "",
          "Nama Orang Tua": s.namaOrtu || "",
          "No Hp Orang Tua": s.noTeleponOrtu || "",
          "Pilihan Instrumen": instr,
          "Pilihan Paket Pertemuan": paketText,
        };
      }
      btnExportExcel.addEventListener("click", () => {
        if (!latestStudents || latestStudents.length === 0)
          return Swal.fire(
            "Tidak ada data",
            "Belum ada data siswa untuk diekspor.",
            "info"
          );
        try {
          const rows = latestStudents.map((s, i) => toRow(s, i));
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.json_to_sheet(rows, {
            header: Object.keys(rows[0]),
          });
          ws["!cols"] = Object.keys(rows[0]).map(() => ({ wch: 22 }));
          ws["!cols"][1] = { wch: 20 }; // ID
          ws["!cols"][2] = { wch: 28 }; // Nama
          ws["!cols"][6] = { wch: 40 }; // Alamat
          XLSX.utils.book_append_sheet(wb, ws, "Data Siswa");
          const d = new Date(),
            fn = `Data_Siswa_${d.getFullYear()}${String(
              d.getMonth() + 1
            ).padStart(2, "0")}${String(d.getDate()).padStart(2, "0")}.xlsx`;
          XLSX.writeFile(wb, fn);
        } catch (err) {
          console.error(err);
          Swal.fire("Gagal", "Terjadi kesalahan saat mengekspor.", "error");
        }
      });

      /* ===== Import Excel ===== */
      btnImportExcel.addEventListener("click", () => fileInput.click());

      function normalizeHeader(h) {
        const s = String(h || "")
          .trim()
          .toLowerCase();
        if (!s) return "";
        if (s.includes("timestamp")) return "__ignore";
        return s
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/\s+/g, " ")
          .replace(/\s/g, "_")
          .replace(/[^\w]+/g, "_");
      }
      const headerMap = [
        { keys: ["id", "doc_id", "id_siswa"], field: "__id_opt" },
        { keys: ["nama"], field: "namaSiswa" },
        { keys: ["tempat_lahir", "tempat"], field: "tempatLahir" },
        {
          keys: ["tanggal_lahir", "tgl_lahir", "tanggal"],
          field: "tanggalLahir",
        },
        { keys: ["jenis_kelamin", "jk", "gender"], field: "jenisKelamin" },
        { keys: ["alamat"], field: "alamat" },
        {
          keys: [
            "no_hp",
            "nohp",
            "hp",
            "nomor_hp",
            "no_telepon",
            "no_telp",
            "nomor_telepon",
          ],
          field: "noTelepon",
        },
        {
          keys: [
            "nama_orang_tua",
            "orang_tua",
            "nama_ortu",
            "nama_ortu_wali",
            "nama_wali",
            "orangtua",
          ],
          field: "namaOrtu",
        },
        {
          keys: [
            "no_hp_orang_tua",
            "no_telp_orang_tua",
            "hp_orang_tua",
            "no_telp_ortu",
            "no_telp_ortu_wali",
            "nomor_hp_ortu",
            "nomor_telp_ortu",
            "hp_ortu",
          ],
          field: "noTeleponOrtu",
        },
        {
          keys: ["pilihan_instrumen", "instrumen", "alat_musik"],
          field: "pilihanIstrumen",
        },
        { keys: ["pilihan_genre", "genre"], field: "__ignore" },
        {
          keys: ["pilihan_paket_pertemuan", "paket", "paket_pertemuan"],
          field: "pilihanPaket",
        },
      ];
      function findFieldByHeader(n) {
        for (const m of headerMap) if (m.keys.includes(n)) return m.field;
        return null;
      }

      function toPayloadFromRow(rowObj) {
        const out = {
          idOpt: "",
          payload: {
            namaSiswa: "",
            tempatLahir: "",
            tanggalLahir: "",
            jenisKelamin: "",
            alamat: "",
            noTelepon: "",
            namaOrtu: "",
            noTeleponOrtu: "",
            pilihanIstrumen: [],
            pilihanPaket: "",
          },
        };
        for (const [rawHeader, value] of Object.entries(rowObj)) {
          const norm = normalizeHeader(rawHeader);
          if (norm === "__ignore" || !norm) continue;
          const field = findFieldByHeader(norm);
          if (!field || field === "__ignore") continue;

          if (field === "__id_opt") {
            out.idOpt = String(value ?? "").trim();
            continue;
          }
          if (field === "tanggalLahir") {
            out.payload.tanggalLahir =
              typeof value === "number"
                ? excelSerialToYMD(value)
                : parseDateStringToYMD(value);
          } else if (field === "noTelepon" || field === "noTeleponOrtu") {
            out.payload[field] = normalizePhone(value);
          } else if (field === "pilihanIstrumen") {
            const arr = String(value || "")
              .split(/[,;\n]/)
              .map((s) => normalizeInstrumen(s))
              .filter(Boolean);
            out.payload.pilihanIstrumen = [...new Set(arr)];
          } else if (field === "pilihanPaket") {
            const raw = String(value ?? "")
              .trim()
              .toLowerCase();
            out.payload.pilihanPaket =
              raw.startsWith("a") || raw.includes("4x")
                ? "A"
                : raw.startsWith("b") || raw.includes("8x")
                ? "B"
                : "";
          } else {
            out.payload[field] = String(value ?? "").trim();
          }
        }
        out.payload.namaSiswa = titleCaseNama(out.payload.namaSiswa);
        out.payload.namaOrtu = titleCaseNama(out.payload.namaOrtu);
        return out;
      }

      const btnAddStudent = document.getElementById("btnAddStudent");
      btnAddStudent.addEventListener("click", () => {
        studentForm.reset();
        studentIdInput.value = "";
        studentIdView.value = "";
        isEditingId = false;
        studentIdView.disabled = true;
        toggleEditIdBtn.textContent = "Ubah ID";
        setMultiSelectValues(pilihanIstrumen, []);
        validateInstrumenRequired();
        modal.show();
      });

      const btnExport = btnExportExcel;
      const btnImport = btnImportExcel;

      btnImport.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        try {
          const data = await file.arrayBuffer();
          const wb = XLSX.read(data, { type: "array", cellDates: true });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { defval: "", raw: true });
          if (!json.length) {
            fileInput.value = "";
            return Swal.fire("Kosong", "File tidak berisi data.", "info");
          }

          const items = json
            .map((r) => toPayloadFromRow(r))
            .filter((x) => x.payload.namaSiswa);
          if (!items.length) {
            fileInput.value = "";
            return Swal.fire(
              "Tidak cocok",
              "Pastikan kolom 'Nama' ada.",
              "warning"
            );
          }

          const preview = items
            .slice(0, 5)
            .map(
              (x, i) =>
                `${i + 1}. ${x.payload.namaSiswa} — ${
                  (x.payload.pilihanIstrumen || []).join(", ") || "-"
                }<br><span style="opacity:.75">TTL: ${
                  x.payload.tempatLahir || "-"
                }, ${x.payload.tanggalLahir || "-"}</span>`
            )
            .join("<br><br>");
          const { isConfirmed } = await Swal.fire({
            title: "Import Excel?",
            html: `Akan mengimpor <b>${
              items.length
            }</b> baris.<br><br><div class="text-start small">${preview}${
              items.length > 5 ? "<br>..." : ""
            }</div>`,
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Impor",
            cancelButtonText: "Batal",
            width: 620,
          });
          if (!isConfirmed) {
            fileInput.value = "";
            return;
          }

          // Dupe key
          const dupeKey = (s) =>
            `${(s.namaSiswa || "").toLowerCase()}|${s.tanggalLahir || ""}`;
          const existingKeys = new Set((latestStudents || []).map(dupeKey));

          let ok = 0,
            skip = 0,
            fail = 0;
          Swal.showLoading();
          for (const it of items) {
            const key = dupeKey(it.payload);
            if (existingKeys.has(key)) {
              skip++;
              continue;
            }

            const customId =
              it.idOpt && /^[a-zA-Z0-9_\-]{4,128}$/.test(it.idOpt)
                ? it.idOpt
                : null;
            try {
              if (customId) {
                const ref = doc(db, STUDENTS_COL, customId);
                const snap = await getDoc(ref);
                if (snap.exists()) {
                  await addStudent(it.payload); // fallback
                } else {
                  await setDoc(ref, it.payload);
                }
              } else {
                await addStudent(it.payload);
              }
              ok++;
            } catch (err) {
              console.error(err);
              fail++;
            }
          }

          Swal.fire(
            "Selesai",
            `Impor selesai.<br><b>${ok}</b> ditambahkan, <b>${skip}</b> dilewati (duplikat), <b>${fail}</b> gagal.`,
            fail ? "warning" : "success"
          );
        } catch (err) {
          console.error(err);
          Swal.fire(
            "Gagal",
            "File tidak dapat diproses. Pastikan format .xlsx valid.",
            "error"
          );
        } finally {
          fileInput.value = "";
        }
      });

      // Mulai realtime + render awal
      onStudentsSnapshot((list) => {
        latestStudents = list;
        applyFilterAndRender();
      });
    </script>

    <!-- Optional libs -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/startbootstrap/startbootstrap-sb-admin-2@4.1.4/js/sb-admin-2.min.js"></script>
  </body>
</html>
